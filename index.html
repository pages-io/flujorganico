<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flujo Orgánico</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #F5F5F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF;
            --primary: #007AFF; --success: #34C759; --warning: #FF9500; --danger: #FF3B30;
            --text-main: #1D1D1F; --text-secondary: #86868B; --text-tertiary: #C7C7CC;
            --border: #E5E5EA; --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.05); --shadow-lg: 0 12px 24px rgba(0,0,0,0.1);
            --radius-md: 18px; --radius-lg: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #AEAEB2; }

        .sidebar { width: 270px; background-color: var(--bg-sidebar); padding: 2rem 1.2rem; display: flex; flex-direction: column; border-right: 1px solid rgba(0,0,0,0.05); z-index: 10; }
        .brand { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 2.5rem; padding-left: 12px; letter-spacing: -0.01em; }
        .brand-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #007AFF, #5AC8FA); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2); }
        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 6px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); font-weight: 500; font-size: 0.95rem; user-select: none; }
        .nav-item:hover { background-color: rgba(0,0,0,0.03); color: var(--text-main); }
        .nav-item.active { background-color: #F2F2F7; color: var(--primary); font-weight: 600; }
        .nav-item i { transition: transform 0.2s; }
        .nav-item.active i { transform: scale(1.05); stroke-width: 2.5px; }

        .main-content { flex: 1; padding: 2.5rem 3.5rem; overflow-y: auto; position: relative; }
        .header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { font-size: 2.2rem; font-weight: 700; letter-spacing: -0.02em; color: var(--text-main); margin-bottom: 4px; }
        .header-subtitle { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 2rem; }
        .card { background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.03); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        
        .stat-card { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-content h3 { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-content .value { font-size: 2.5rem; font-weight: 700; letter-spacing: -0.03em; color: var(--text-main); line-height: 1; }
        .stat-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .icon-blue { background: rgba(0,122,255,0.1); color: var(--primary); }
        .icon-green { background: rgba(52,199,89,0.1); color: var(--success); }
        .icon-orange { background: rgba(255,149,0,0.1); color: var(--warning); }

        .btn { background-color: var(--text-main); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); background-color: black; }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 0; width: 36px; height: 36px; border-radius: 50%; box-shadow: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .btn-ghost.danger:hover { color: var(--danger); }
        .btn-ai { background: linear-gradient(135deg, #AF52DE, #5856D6); color: white; border: none; padding: 8px 16px; border-radius: 100px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(175, 82, 222, 0.3); }
        .btn-ai:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(175, 82, 222, 0.4); }
        .btn-ai.loading { opacity: 0.7; cursor: wait; }
        .btn-mini-ai { background: none; border: none; color: #AF52DE; cursor: pointer; padding: 2px; border-radius: 4px; transition: all 0.2s; }
        .btn-mini-ai:hover { background: rgba(175, 82, 222, 0.1); transform: scale(1.1); }

        .form-input, .form-textarea, input[type="datetime-local"], input[type="date"], input[type="number"], input[type="text"] {
            width: 100%; padding: 0 16px; border: 1px solid var(--border); border-radius: 12px; outline: none; font-size: 0.95rem; background: #FAFAFA; transition: all 0.2s; margin-bottom: 1.2rem; color: var(--text-main); font-family: 'Inter', sans-serif; appearance: none; -webkit-appearance: none; box-sizing: border-box; height: 48px; line-height: 48px;
        }
        .form-textarea { height: auto; min-height: 100px; padding: 12px 16px; line-height: 1.5; }
        .form-input:focus, .form-textarea:focus, input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="datetime-local"]::-webkit-calendar-picker-indicator { background-color: transparent; color: var(--text-tertiary); cursor: pointer; padding: 5px; margin-right: -5px; opacity: 0.5; transition: opacity 0.2s; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover, input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        
        label { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 8px; display: block; color: var(--text-secondary); text-transform: uppercase; }

        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-options-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); margin-top: 8px; padding: 6px; z-index: 100; display: none; max-height: 220px; overflow-y: auto; border: 1px solid var(--border); }
        .custom-options-list.show { display: block; animation: fadeIn 0.15s ease-out; }
        .custom-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; color: var(--text-main); transition: background 0.1s; display: flex; align-items: center; gap: 10px; }
        .custom-option:hover { background-color: #F2F2F7; }
        .custom-option.selected { background-color: rgba(0, 122, 255, 0.08); color: var(--primary); font-weight: 600; }

        .color-picker-container { display: flex; gap: 15px; margin-bottom: 25px; justify-content: flex-start; }
        .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; position: relative; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { transform: scale(1.15); box-shadow: 0 0 0 2px white, 0 0 0 4px #E5E5EA; }

        .toggle-switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E5E5EA; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        .project-list { display: flex; flex-direction: column; gap: 12px; }
        .project-item { background: white; padding: 1rem 1.5rem; border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: all 0.2s ease; }
        .project-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .project-info-left { display: flex; align-items: center; gap: 16px; }
        .project-icon-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-active { background: var(--success); box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2); }
        .dot-inactive { background: #C7C7CC; }
        .badge { padding: 4px 10px; border-radius: 100px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; }
        .badge-active { background: rgba(52, 199, 89, 0.1); color: var(--success); }
        .badge-inactive { background: #F2F2F7; color: #8E8E93; }

        .task-container { background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); overflow: hidden; margin-top: 1.5rem; border: 1px solid var(--border); }
        .task-item-ui { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 16px; transition: background 0.1s; }
        .task-item-ui:last-child { border-bottom: none; }
        .task-item-ui:hover { background: #FAFAFA; }
        .task-meta-row { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.8rem; color: var(--text-secondary); margin-top: 6px; align-items: center; }
        .task-status-badge { font-size: 0.7rem; padding: 3px 10px; border-radius: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; }
        .ts-todo { background: #F2F2F7; color: #8E8E93; }
        .ts-progress { background: rgba(0, 122, 255, 0.1); color: var(--primary); }
        .ts-done { background: rgba(52, 199, 89, 0.1); color: var(--success); }
        .ts-overdue { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

        .ios-checkbox { appearance: none; width: 22px; height: 22px; border: 2px solid #C7C7CC; border-radius: 50%; outline: none; cursor: pointer; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; margin-top: 2px; }
        .ios-checkbox:checked { background-color: var(--primary); border-color: var(--primary); }
        .ios-checkbox:checked::after { content: ''; position: absolute; top: 45%; left: 50%; width: 6px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: translate(-50%, -50%) rotate(45deg); }
        .task-text { font-size: 1rem; flex: 1; color: var(--text-main); transition: color 0.2s; line-height: 1.4; font-weight: 500; }
        .task-text.completed { color: #C7C7CC; text-decoration: line-through; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; width: 100%; }
        .cal-header { padding: 12px 0; text-align: center; font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; background: white; min-width: 0; }
        .cal-day { min-height: 100px; padding: 8px; position: relative; background: white; min-width: 0; }
        .cal-day.today .day-num { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.4); }
        .day-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        .cal-task-dot { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; background: rgba(0, 122, 255, 0.1); color: var(--primary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; gap: 5px; border-left: 3px solid transparent; }
        .cal-task-dot:hover { transform: scale(1.02); opacity: 0.9; }
        .cal-task-dot.done { text-decoration: line-through; opacity: 0.6; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: flex-start; z-index: 1000; padding-top: 10vh; overflow-y: auto; }
        .modal-content { background: white; padding: 2.5rem; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.98); animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; margin-bottom: 5vh; overflow: hidden; }
        @keyframes popIn { to {transform: scale(1); opacity: 1;} }
        
        .info-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px; letter-spacing: 0.05em; }
        .info-value { font-size: 1rem; color: var(--text-main); margin-bottom: 16px; font-weight: 500; }
        .project-chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; color: white; }
        
        .dashboard-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid var(--border); transition: background 0.1s; border-radius: 8px; }
        .dashboard-list-item:hover { background: #FAFAFA; }
        .dashboard-list-item:last-child { border-bottom: none; }
        .dashboard-task-name { font-weight: 500; color: var(--text-main); }
        .dashboard-proj-tag { font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; color: white; margin-left: 10px; text-transform: uppercase; letter-spacing: 0.02em; }
        
        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F5F5F7; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 3rem; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; }
        .login-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #007AFF, #5AC8FA); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; margin: 0 auto 20px; box-shadow: 0 8px 20px rgba(0,122,255,0.3); }

        /* ACTIVITY LOG */
        .activity-item { padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: flex-start; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { margin-top: 2px; }
        .activity-text { font-size: 0.9rem; color: var(--text-main); line-height: 1.4; }
        .activity-date { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .sidebar { 
                position: fixed; bottom: 0; left: 0; right: 0; 
                width: 100%; height: auto; 
                flex-direction: row; padding: 10px; 
                border-top: 1px solid var(--border); border-right: none;
                background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
                justify-content: space-around;
                box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
                z-index: 100;
            }
            .brand { display: none; }
            .nav-links { flex-direction: row; width: 100%; justify-content: space-around; gap: 0; }
            .nav-item { flex-direction: column; gap: 4px; padding: 6px; font-size: 0.65rem; }
            .nav-item i { width: 24px; height: 24px; margin-bottom: 2px; }
            
            .main-content { 
                padding: 1.5rem; 
                padding-bottom: 100px; 
                height: 100%; 
                overflow: visible; 
            }
            .header h1 { font-size: 1.8rem; }
            
            .modal-content { width: 95%; max-width: none; border-radius: 24px; }
            .project-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .project-item > div { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    
    <div id="login-overlay">
        <div class="login-card">
            <div class="login-icon"><i data-lucide="command" style="width: 32px; height: 32px;"></i></div>
            <h1 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-main);">Bienvenido</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Ingresa un nombre único para cargar tus datos.</p>
            <input type="text" id="login-id-input" class="form-input" placeholder="Ej: juan, empresa-x, demo..." style="text-align: center; font-weight: 600; font-size: 1.1rem;">
            <button class="btn" id="btn-login-action" style="width: 100%; padding: 14px; background: var(--primary);">Entrar</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i data-lucide="command" style="width: 18px; height: 18px;"></i></div>
            <span>Flujo Orgánico</span>
        </div>
        <ul class="nav-links">
            <li class="nav-item active" data-tab="dashboard"><i data-lucide="layout-grid"></i><span>Resumen</span></li>
            <li class="nav-item" data-tab="proyectos"><i data-lucide="layers"></i><span>Proyectos</span></li>
            <li class="nav-item" data-tab="calendario"><i data-lucide="calendar"></i><span>Calendario</span></li>
            <li class="nav-item" data-tab="analiticas"><i data-lucide="pie-chart"></i><span>Reportes</span></li>
            <li class="nav-item" data-tab="configuracion"><i data-lucide="settings"></i><span>Ajustes</span></li>
        </ul>
        <div style="font-size: 0.7rem; color: var(--text-tertiary); margin-top: auto; padding-top: 20px; text-align: center; display: none;">v36.0 Final Stable</div>
    </nav>

    <main class="main-content">
        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="header">
                <div><div class="header-subtitle" id="date-display"></div><h1>Buenos días</h1></div>
            </div>
            <div class="card-grid">
                <div class="card stat-card" id="card-projects">
                    <div class="stat-content"><h3>PROYECTOS ACTIVOS</h3><div class="value" id="dash-total">0</div></div>
                    <div class="stat-icon icon-blue"><i data-lucide="folder-open" style="width:24px; height:24px;"></i></div>
                </div>
                <div class="card stat-card" id="card-today">
                    <div class="stat-content"><h3>TAREAS HOY</h3><div class="value" id="dash-today" style="color: var(--primary);">0</div></div>
                    <div class="stat-icon icon-orange"><i data-lucide="list-checks" style="width:24px; height:24px;"></i></div>
                </div>
                <div class="card stat-card" id="card-completed">
                    <div class="stat-content"><h3>TAREAS FINALIZADAS</h3><div class="value" id="dash-done" style="color: var(--success);">0</div></div>
                    <div class="stat-icon icon-green"><i data-lucide="check-circle-2" style="width:24px; height:24px;"></i></div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.1rem; color: var(--text-main); font-weight: 600;">Actividad Reciente</h3>
                    <i data-lucide="history" style="color: var(--text-tertiary); width: 20px;"></i>
                </div>
                <div id="recent-activity-list" style="font-size: 0.95rem; color: var(--text-secondary);"></div>
            </div>
        </section>

        <!-- PROYECTOS -->
        <section id="proyectos" class="section">
            <div id="projects-view-list">
                <div class="header">
                    <div><div class="header-subtitle">GESTIÓN</div><h1>Mis Proyectos</h1></div>
                    <button class="btn" id="btn-new-project"><i data-lucide="plus" style="width: 18px; margin-right: 5px;"></i> Nuevo</button>
                </div>
                <div id="project-list" class="project-list"></div>
            </div>

            <!-- DETAIL VIEW HIDDEN BY DEFAULT -->
            <div id="projects-view-detail" class="detail-view" style="display: none;">
                <div class="back-nav" id="btn-back-projects"><i data-lucide="chevron-left" style="width: 18px; margin-right: 2px;"></i> Proyectos</div>
                <div class="header" style="margin-bottom: 2rem;">
                    <div style="display:flex; justify-content:space-between; width:100%; align-items: flex-start;">
                        <div>
                            <div style="display:flex; align-items:center; gap: 10px; margin-bottom: 12px;">
                                <h1 id="detail-title" style="margin-bottom: 0; font-size: 2rem;">Nombre Proyecto</h1>
                                <button class="btn-ghost" id="btn-edit-project" style="color:var(--text-secondary);"><i data-lucide="pencil" style="width: 18px;"></i></button>
                            </div>
                            <div style="display:flex; align-items:center; gap: 10px; flex-wrap: wrap;">
                                <span class="project-chip" style="background: #F2F2F7; color: var(--text-secondary); font-weight: 500;"><i data-lucide="calendar" style="width: 14px; margin-right: 6px;"></i> Contratado: <span id="detail-contract"></span></span>
                                <span class="project-chip" style="background: #F2F2F7; color: var(--text-secondary); font-weight: 500;"><i data-lucide="file-text" style="width: 14px; margin-right: 6px;"></i> <span id="detail-pubs">0</span> / semana</span>
                                <span id="detail-badge" class="badge"></span>
                            </div>
                        </div>
                        <div style="text-align:right; background:white; padding:10px 15px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border:1px solid var(--border); min-width: 140px;">
                            <div style="font-size:0.7rem; color:var(--text-secondary); font-weight:700; text-transform:uppercase; margin-bottom:6px; letter-spacing:0.05em;">Esta Semana</div>
                            <div style="display:flex; align-items:baseline; justify-content:flex-end; gap:4px;">
                                <span id="weekly-count" style="font-size:1.8rem; font-weight:700; color:var(--text-main); line-height:1;">0</span>
                                <span id="weekly-total" style="font-size:1rem; color:var(--text-tertiary); font-weight:600;">/ 0</span>
                            </div>
                            <div id="weekly-status" style="font-size:0.8rem; font-weight:600; color:var(--warning); margin-top:4px;">Sin completar</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 25px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 10px; font-weight:600; font-size: 0.9rem; color: var(--text-secondary);"><span>PROGRESO GLOBAL</span><span id="detail-percent" style="color:var(--text-main);">0%</span></div>
                    <div style="width:100%; height:8px; background:#F2F2F7; border-radius:100px; overflow:hidden;"><div id="detail-bar" style="width:0%; height:100%; background:var(--primary); transition: width 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); border-radius: 100px;"></div></div>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap:10px;">
                    <button class="btn-ai" id="btn-ai-suggest"><i data-lucide="sparkles" style="width: 16px;"></i> Sugerir Tareas</button>
                    <button class="btn" style="padding: 10px 18px; font-size: 0.9rem;" id="btn-new-task"><i data-lucide="plus" style="width: 16px;"></i> Nueva Tarea</button>
                </div>
                <div class="task-container"><ul id="task-list-ui" class="task-list-ui" style="list-style: none;"></ul></div>
            </div>
        </section>

        <section id="calendario" class="section">
            <div class="header">
                <div><div class="header-subtitle">AGENDA</div><h1>Calendario</h1></div>
                <h3 id="calendar-month-name" style="color: var(--primary); font-size: 1.4rem; font-weight: 600;"></h3>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </section>

        <section id="analiticas" class="section">
            <div class="header"><div><div class="header-subtitle">MÉTRICAS</div><h1>Rendimiento</h1></div></div>
            <div class="card-grid">
                <div class="card" style="text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <h3 style="margin-bottom: 2rem; width:100%; text-align:left;">Estado de Proyectos</h3>
                    <div style="position: relative; width: 220px; height: 220px;">
                        <canvas id="statusChart" width="220" height="220" style="width: 100%; height: 100%;"></canvas>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                            <div id="chart-total" style="font-size:2.5rem; font-weight:700; color: var(--text-main);">0</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary); font-weight:600;">TOTAL</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Productividad</h3>
                    <p style="margin-top: 1rem; color: var(--text-secondary); line-height: 1.6; font-size: 1rem;">Mantener tus proyectos en estado "Activo" ayuda a priorizar el flujo de trabajo semanal.</p>
                    <div style="margin-top: 3rem; padding: 2rem; background: #F9F9F9; border-radius: 20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span style="font-weight:600; font-size:0.9rem;">Completado Global</span><span id="global-completion-rate" style="font-weight:700; color:var(--success);">0%</span></div>
                        <div style="width: 100%; background: #E5E5EA; height: 10px; border-radius: 100px;"><div id="global-completion-bar" style="width: 0%; background: var(--success); height: 100%; border-radius: 100px; transition: width 0.8s;"></div></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="configuracion" class="section">
            <div class="header"><div><div class="header-subtitle">SISTEMA</div><h1>Ajustes</h1></div></div>
            <div class="card-grid">
                
                <!-- PROFILE SECTION -->
                <div class="card">
                    <div style="display:flex; align-items:flex-start; gap: 20px;">
                        <div style="background: #E5E5EA; padding: 15px; border-radius: 12px; font-size: 1.5rem; color: var(--text-main);"><i data-lucide="user"></i></div>
                        <div style="flex: 1;">
                            <h3 style="color:var(--text-main); font-size:1.1rem; margin-bottom: 8px;">Perfil</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9rem;">Identificador único de sincronización.</p>
                            
                            <!-- Profile ID Area with Edit Button -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="background: #F5F5F7; padding: 10px; border-radius: 8px; font-family: monospace; font-weight: 600; flex: 1;" id="settings-user-id">...</div>
                                <button class="btn-ghost" id="btn-change-profile-name" title="Editar Nombre de Perfil" style="background: #F2F2F7; border-radius: 8px; width: 40px; height: 40px;">
                                    <i data-lucide="pencil" style="width: 18px; color: var(--primary);"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" style="background: white; border: 1px solid var(--border); color: var(--text-main);" id="btn-logout">
                                    <i data-lucide="log-out" style="width:16px; margin-right:5px;"></i> Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; align-items:flex-start; gap: 20px;">
                        <div style="background: #FFF0F0; padding: 15px; border-radius: 12px; font-size: 1.5rem; color: var(--danger);"><i data-lucide="trash-2"></i></div>
                        <div>
                            <h3 style="color:var(--text-main); font-size:1.1rem; margin-bottom: 8px;">Zona de Peligro</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5;">Esta acción eliminará todos los datos asociados al ID actual. No se puede deshacer.</p>
                            <button class="btn" style="background-color: #FFF0F0; color: var(--danger); box-shadow:none; border: 1px solid rgba(255, 59, 48, 0.2);" id="btn-clear-data">Borrar Datos</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modals -->
        <div id="project-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="project-modal-title" style="margin-bottom: 0.5rem; font-size: 1.5rem;">Nuevo Proyecto</h2>
                <p style="color:var(--text-secondary); margin-bottom: 2rem; font-size: 0.95rem;">Gestiona la información general del proyecto.</p>
                <form id="project-form" novalidate>
                    <label>NOMBRE DEL PROYECTO</label>
                    <input type="text" id="p-name" class="form-input" placeholder="Ej: Redes Sociales Cliente A">
                    <label>COLOR</label>
                    <div class="color-picker-container" id="color-picker"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div><label>CONTRATACIÓN</label><input type="date" id="p-contract" class="form-input"></div>
                        <div><label>PUBS / SEMANA</label><input type="number" id="p-pubs" class="form-input" min="0" placeholder="Ej: 3"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; margin-bottom: 25px;">
                        <label style="font-size:1rem; font-weight:500; color:var(--text-main); text-transform: none;">Proyecto Activo</label>
                        <label class="toggle-switch"><input type="checkbox" id="p-active" checked><span class="slider"></span></label>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                        <button type="button" class="btn" style="background:transparent; color:var(--text-secondary); box-shadow:none; padding: 10px 20px;" id="btn-cancel-project">Cancelar</button>
                        <button type="button" class="btn" style="background: var(--primary);" id="btn-save-project">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW PROFILE EDIT MODAL -->
        <div id="profile-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 style="margin-bottom: 0.5rem; font-size: 1.5rem;">Editar Perfil</h2>
                <p style="color:var(--text-secondary); margin-bottom: 2rem; font-size: 0.95rem;">Ingresa un nuevo nombre para identificar tus datos.</p>
                <form id="profile-form" onsubmit="return false;">
                    <label>NUEVO ID DE USUARIO</label>
                    <input type="text" id="input-edit-profile-id" class="form-input" placeholder="Ej: nuevo-usuario">
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                        <button class="btn" style="background:transparent; color:var(--text-secondary); box-shadow:none; padding: 10px 20px;" id="btn-cancel-profile">Cancelar</button>
                        <button class="btn" style="background: var(--primary);" id="btn-save-profile">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="task-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="task-modal-title" style="margin-bottom: 0.5rem; font-size: 1.5rem;">Nueva Tarea</h2>
                <p style="color:var(--text-secondary); margin-bottom: 2rem; font-size: 0.95rem;">El estado se calculará automáticamente.</p>
                <form id="task-form" novalidate>
                    <label>NOMBRE DE LA TAREA</label>
                    <input type="text" id="t-name" class="form-input" placeholder="Ej: Redactar copy">
                    <div style="display:flex; justify-content:space-between; align-items:baseline;">
                        <label>DESCRIPCIÓN</label>
                        <button type="button" class="btn-mini-ai" id="btn-ai-improve" title="Mejorar con IA"><i data-lucide="sparkles" style="width:14px; height:14px;"></i> Mejorar</button>
                    </div>
                    <textarea id="t-desc" class="form-textarea" rows="3" placeholder="Detalles..."></textarea>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div><label>INICIO</label><input type="datetime-local" id="t-start" class="form-input"></div>
                        <div><label>FIN</label><input type="datetime-local" id="t-end" class="form-input"></div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                        <button type="button" class="btn" style="background:transparent; color:var(--text-secondary); box-shadow:none; padding: 10px 20px;" id="btn-cancel-task">Cancelar</button>
                        <button type="button" class="btn" style="background: var(--primary);" id="btn-save-task">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="dashboard-detail-modal" class="modal-overlay">
            <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2 id="db-modal-title" style="margin:0; font-size:1.5rem;">Detalle</h2>
                    <button id="btn-close-db-modal" style="background:none; border:none; cursor:pointer;"><i data-lucide="x" style="color:var(--text-secondary);"></i></button>
                </div>
                <div id="db-modal-filter-section" style="margin-bottom: 20px; display: none;">
                    <label>FILTRAR POR PROYECTO</label>
                    <div class="custom-select-wrapper">
                        <div style="position: relative;">
                            <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-tertiary);"></i>
                            <input type="text" id="db-modal-search" class="form-input" placeholder="Buscar o seleccionar..." style="padding-left: 36px; margin-bottom:0; cursor:pointer;">
                            <i data-lucide="chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-tertiary); pointer-events: none;"></i>
                        </div>
                        <div id="db-custom-options" class="custom-options-list"></div>
                    </div>
                </div>
                <div id="db-modal-list" style="overflow-y: auto; flex: 1;"></div>
            </div>
        </div>

        <div id="cal-task-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 20px;">
                    <h2 style="font-size: 1.4rem; margin:0;">Información</h2>
                    <button id="btn-close-cal-modal" style="background:none; border:none; cursor:pointer;"><i data-lucide="x" style="color:var(--text-secondary);"></i></button>
                </div>
                <div class="info-label">PROYECTO</div><div id="cal-modal-project" class="project-chip"></div>
                <div class="info-label" style="margin-top:12px;">TAREA</div><div id="cal-modal-task" class="info-value"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><div class="info-label">INICIO</div><div id="cal-modal-start" class="info-value" style="font-size:0.9rem;"></div></div>
                    <div><div class="info-label">FIN</div><div id="cal-modal-end" class="info-value" style="font-size:0.9rem;"></div></div>
                </div>
                <div class="info-label">ESTADO</div><div id="cal-modal-status"></div>
                <div style="margin-top: 25px; text-align:right;"><button class="btn" id="btn-close-cal-modal-action">Cerrar</button></div>
            </div>
        </div>

        <div id="confirmation-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="margin-bottom: 20px; background: #FEE2E2; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: auto;"><i data-lucide="alert-triangle" style="color: var(--danger); width: 30px; height: 30px;"></i></div>
                <h2 id="conf-modal-title" style="margin-bottom: 10px; font-size: 1.4rem;">¿Estás seguro?</h2>
                <p id="conf-modal-msg" style="color: var(--text-secondary); margin-bottom: 25px;">Esta acción no se puede deshacer.</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" style="background: transparent; color: var(--text-secondary); box-shadow: none; border: 1px solid var(--border);" id="btn-cancel-delete">Cancelar</button>
                    <button class="btn" style="background: var(--danger); color: white;" id="btn-confirm-delete">Eliminar</button>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDQXAE8k0ZUG-4bygz_UDXS4WcGuJQ1pHo",
            authDomain: "administradordeproyectos-cb460.firebaseapp.com",
            projectId: "administradordeproyectos-cb460",
            storageBucket: "administradordeproyectos-cb460.firebasestorage.app",
            messagingSenderId: "823768215696",
            appId: "1:823768215696:web:331cfc69305cff0af02815",
            measurementId: "G-VFY50PWNV1"
        };
        const apiKey = ""; 

        const app = {
            data: { projects: [], activityLog: [] },
            currentProjectId: null,
            editingProjectId: null,
            editingTaskId: null,
            pendingDelete: null,
            selectedColor: '#007AFF',
            currentDashboardListItems: [],
            currentFilterValue: 'all',
            userId: null,
            authUserId: null,
            db: null,
            auth: null,
            appId: 'administrador-proyectos-main',
            listenerUnsubscribe: null,
            colors: ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#8E8E93'],

            // 1. HELPERS & UTILS
            sendNotification(title, body) {
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification(title, { body, icon: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/bell.svg' });
                }
            },
            
            checkNotificationTriggers() {
                const now = new Date(); const currentHour = now.getHours();
                if (currentHour >= 8 && currentHour <= 20) {
                    const lastReminder = localStorage.getItem('last_periodic_reminder');
                    const fourHours = 4 * 60 * 60 * 1000;
                    if (!lastReminder || (now.getTime() - parseInt(lastReminder)) > fourHours) {
                        this.sendNotification("Recordatorio", "Revisa el estado de tus tareas.");
                        localStorage.setItem('last_periodic_reminder', now.getTime());
                    }
                }
                if(this.data && this.data.projects) {
                    this.data.projects.forEach(p => {
                        if (!p.active) return;
                        p.tasks.forEach(t => {
                            if (t.done) return;
                            const start = t.start ? new Date(t.start) : null;
                            const end = t.end ? new Date(t.end) : null;
                            if (start && now >= start && !t.notifiedStart) {
                                this.sendNotification("Tarea Iniciada", `"${t.text}" ha comenzado.`);
                                t.notifiedStart = true; this.saveData(); 
                            }
                            if (end) {
                                const isToday = end.getDate() === now.getDate() && end.getMonth() === now.getMonth();
                                if (isToday && !t.notifiedLastDay) {
                                    this.sendNotification("Último Día", `"${t.text}" vence hoy.`);
                                    t.notifiedLastDay = true; this.saveData();
                                }
                                if (now > end && !t.notifiedOverdue) {
                                    this.sendNotification("Vencida", `"${t.text}" ha expirado.`);
                                    t.notifiedOverdue = true; this.saveData();
                                }
                            }
                        });
                    });
                }
            },

            logActivity(text) {
                if (!this.data.activityLog) this.data.activityLog = [];
                const now = new Date();
                this.data.activityLog.unshift({ text, date: now.toISOString() });
                if (this.data.activityLog.length > 20) this.data.activityLog.pop();
            },

            updateUserId(newId) {
                this.userId = newId;
                localStorage.setItem('flujo_custom_id', newId);
                this.renderUserId();
                this.setupFirestoreListener(); 
            },

            renderUserId() {
                const el = document.getElementById('settings-user-id');
                if(el && this.userId) el.textContent = this.userId;
            },

            // 2. INIT & DATA
            async init() {
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.auth = getAuth(firebaseApp);
                    this.db = getFirestore(firebaseApp);

                    await signInAnonymously(this.auth);

                    onAuthStateChanged(this.auth, (user) => {
                        if (user) {
                            this.authUserId = user.uid;
                            const savedId = localStorage.getItem('flujo_custom_id');
                            if (savedId) {
                                this.userId = savedId;
                                this.renderUserId();
                                this.setupFirestoreListener();
                                document.getElementById('login-overlay').style.display = 'none'; 
                            } else {
                                document.getElementById('login-overlay').style.display = 'flex';
                            }
                        }
                    });

                    this.setupDates();
                    this.setupEventListeners();
                    this.renderColorPicker();
                    // Initial Safe Render
                    this.renderDashboard(); 
                    this.renderProjects();
                    
                    if ("Notification" in window) {
                        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                            Notification.requestPermission();
                        }
                    }
                    setInterval(() => this.checkNotificationTriggers(), 60000); 

                } catch(e) { console.error("Init Error", e); }
                lucide.createIcons();
            },

            setupFirestoreListener() {
                if (this.listenerUnsubscribe) this.listenerUnsubscribe();
                if (!this.userId) return;

                const docRef = doc(this.db, 'artifacts', this.appId, 'public', 'data', 'files', this.userId);
                this.listenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.data = docSnap.data();
                        if (!this.data.activityLog) this.data.activityLog = [];
                        
                        if(this.currentProjectId) {
                             const p = this.data?.projects?.find(proj => proj.id === this.currentProjectId);
                             if(p) this.renderTasks(p);
                        }
                        this.renderDashboard();
                        this.renderProjects();
                        this.renderAnalytics();
                        this.renderCalendar();
                    } else {
                        // Initialize empty
                        this.data = { projects: [], activityLog: [] };
                        this.saveData();
                    }
                });
            },

            saveData() {
                if (!this.db || !this.userId) return Promise.resolve();
                const docRef = doc(this.db, 'artifacts', this.appId, 'public', 'data', 'files', this.userId);
                return setDoc(docRef, this.data);
            },

            // 3. RENDERERS
            renderColorPicker() {
                const container = document.getElementById('color-picker'); 
                if (!container) return;
                container.innerHTML = '';
                this.colors.forEach(c => {
                    const div = document.createElement('div'); div.className = 'color-option'; div.style.backgroundColor = c;
                    if(c === this.selectedColor) div.classList.add('selected');
                    div.onclick = () => { this.selectedColor = c; this.renderColorPicker(); };
                    container.appendChild(div);
                });
            },

            renderDashboard() {
                if(!this.data || !this.data.projects) return;
                const activeProjects = this.data.projects.filter(p => p.active);
                let tasksTodayCount = 0; let tasksDoneCount = 0;
                const today = new Date(); today.setHours(0,0,0,0);
                this.data.projects.forEach(p => {
                    p.tasks.forEach(t => {
                        if(t.done) tasksDoneCount++;
                        if (!t.done && t.start && t.end) {
                            const start = new Date(t.start); start.setHours(0,0,0,0);
                            const end = new Date(t.end); end.setHours(23,59,59,999);
                            if (today >= start && today <= end) tasksTodayCount++;
                        }
                    });
                });
                document.getElementById('dash-total').textContent = activeProjects.length;
                document.getElementById('dash-today').textContent = tasksTodayCount;
                document.getElementById('dash-done').textContent = tasksDoneCount;
                
                const list = document.getElementById('recent-activity-list');
                list.innerHTML = '';
                if (this.data.activityLog && this.data.activityLog.length > 0) {
                     this.data.activityLog.slice(0, 5).forEach(act => {
                         const time = new Date(act.date).toLocaleString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' });
                         const item = document.createElement('div');
                         item.className = 'activity-item';
                         item.innerHTML = `
                            <i data-lucide="activity" class="activity-icon" style="width:16px; color:var(--primary); flex-shrink: 0;"></i>
                            <div>
                                <div class="activity-text">${act.text}</div>
                                <div class="activity-date">${time}</div>
                            </div>
                         `;
                         list.appendChild(item);
                     });
                     lucide.createIcons();
                } else {
                    list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-tertiary);">Sin actividad reciente.</div>';
                }
            },

            renderProjects() {
                const list = document.getElementById('project-list'); list.innerHTML = '';
                if (!this.data.projects || this.data.projects.length === 0) {
                    list.innerHTML = `<div class="empty-state" style="text-align: center; padding: 2rem; color: var(--text-tertiary);"><i data-lucide="folder-dashed" style="width:48px;height:48px; margin-bottom: 10px; opacity: 0.5;"></i><p>Sin proyectos</p></div>`;
                    lucide.createIcons(); return;
                }
                this.data.projects.forEach(p => {
                    const div = document.createElement('div'); div.className = 'project-item';
                    const pColor = p.color || '#007AFF'; const activeClass = p.active ? 'dot-active' : 'dot-inactive';
                    div.innerHTML = `<div class="project-info-left"><div class="project-icon-box" style="background:${this.hexToRgba(pColor,0.1)}; color:${pColor};"><i data-lucide="folder" style="width:20px;"></i></div><div><div style="display:flex;align-items:center;margin-bottom:4px;"><span class="status-dot ${activeClass}"></span><h3 style="font-size:1rem;font-weight:600;">${p.name}</h3></div><div style="color:var(--text-secondary);font-size:0.85rem;">${p.pubs} pubs/sem</div></div></div><div style="display:flex;align-items:center;gap:20px;"><div style="text-align:right;"><div style="font-size:0.7rem;font-weight:700;color:var(--text-tertiary);">TAREAS</div><div style="font-size:0.9rem;font-weight:600;">${p.tasks.filter(t=>t.done).length}/${p.tasks.length}</div></div><button class="btn-ghost danger delete-btn"><i data-lucide="trash-2" style="width:18px;"></i></button><i data-lucide="chevron-right" style="color:#D2D2D7; width: 20px;"></i></div>`;
                    
                    div.addEventListener('click', () => app.openProject(p.id));
                    const delBtn = div.querySelector('.delete-btn');
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); app.deleteProject(e, p.id); });
                    
                    list.appendChild(div);
                });
                lucide.createIcons();
            },

            renderTasks(p) {
                this.updateProjectWeeklyStats(p);
                const ui = document.getElementById('task-list-ui'); ui.innerHTML = '';
                const total = p.tasks.length; const done = p.tasks.filter(t => t.done).length;
                const percent = total === 0 ? 0 : Math.round((done/total)*100);
                document.getElementById('detail-percent').textContent = `${percent}%`;
                document.getElementById('detail-bar').style.width = `${percent}%`;

                if(total===0) { ui.innerHTML = `<div class="empty-state" style="padding:2rem;"><p>Sin tareas</p></div>`; return; }

                p.tasks.forEach(t => {
                    const status = this.getTaskStatus(t);
                    let startDate = 'Sin fecha', endDate = 'Sin fecha';
                    if (t.start && !isNaN(new Date(t.start).getTime())) startDate = new Date(t.start).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                    if (t.end && !isNaN(new Date(t.end).getTime())) endDate = new Date(t.end).toLocaleString([], {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                    const li = document.createElement('li'); li.className = 'task-item-ui';
                    li.innerHTML = `<div class="checkbox-wrapper" style="cursor:pointer;"><input type="checkbox" class="ios-checkbox" ${t.done?'checked':''} readonly></div><div style="flex:1;"><div style="display:flex;justify-content:space-between;"><span class="task-text ${t.done?'completed':''}" style="font-weight:600;">${t.text}</span><div style="display:flex;align-items:center;gap:8px;">${status.isOverdue ? `<span style="color:var(--danger);font-size:0.7rem;font-weight:600;display:flex;align-items:center;gap:4px;"><i data-lucide="alert-circle" style="width:14px;"></i> Verificar</span>`:''}<span class="task-status-badge ${status.class}">${status.label}</span></div></div><div style="font-size:0.9rem;color:#555;margin-top:4px;">${t.desc||''}</div><div class="task-meta-row"><span><i data-lucide="clock" style="width:12px;vertical-align:middle;"></i> ${startDate}</span><span><i data-lucide="flag" style="width:12px;vertical-align:middle;"></i> ${endDate}</span></div></div><div style="display:flex;gap:5px;"><button class="btn-ghost edit-task-btn"><i data-lucide="pencil" style="width:16px;color:#007AFF;"></i></button><button class="btn-ghost danger delete-task-btn"><i data-lucide="trash-2" style="width:16px;"></i></button></div>`;
                    li.querySelector('.checkbox-wrapper').onclick = () => this.toggleTaskDone(t.id);
                    li.querySelector('.edit-task-btn').onclick = () => this.openEditTaskModal(t.id);
                    li.querySelector('.delete-task-btn').onclick = () => this.deleteTask(t.id);
                    ui.appendChild(li);
                });
                lucide.createIcons();
            },

            renderCalendar() {
                const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
                const now = new Date(), year = now.getFullYear(), month = now.getMonth();
                const monthName = new Date(year, month).toLocaleString('es-ES', { month: 'long' });
                const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                document.getElementById('calendar-month-name').textContent = `${capitalizedMonth} ${year}`;
                
                ['D','L','M','X','J','V','S'].forEach(d => { const h=document.createElement('div'); h.className='cal-header'; h.textContent=d; grid.appendChild(h); });
                const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month+1, 0).getDate();
                for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
                for(let i=1; i<=daysInMonth; i++) {
                    const cell = document.createElement('div'); cell.className='cal-day'; if(i===now.getDate()) cell.classList.add('today');
                    cell.innerHTML = `<div class="day-num">${i}</div>`;
                    const currentDt = new Date(year, month, i); currentDt.setHours(0,0,0,0);
                    if(this.data.projects) {
                        this.data.projects.forEach(p => {
                            if(p.active) p.tasks.forEach(t => {
                                if(!t.start || !t.end) return;
                                const start=new Date(t.start); start.setHours(0,0,0,0);
                                const end=new Date(t.end); end.setHours(0,0,0,0);
                                if(currentDt >= start && currentDt <= end) {
                                    const div = document.createElement('div'); div.className = `cal-task-dot ${t.done?'done':''}`;
                                    const isDeadline = currentDt.getTime() === end.getTime();
                                    div.innerHTML = `${isDeadline ? '<i data-lucide="flag" style="width:12px;"></i>' : ''} ${t.text}`;
                                    div.style.color = p.color; div.style.borderLeftColor = p.color; div.style.background = this.hexToRgba(p.color||'#007AFF', 0.1);
                                    div.onclick = (e) => { e.stopPropagation(); this.openCalendarTaskInfo(p.id, t.id); };
                                    cell.appendChild(div);
                                }
                            });
                        });
                    }
                    grid.appendChild(cell);
                }
            },

            renderAnalytics() {
                const canvas = document.getElementById('statusChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const total = this.data.projects ? this.data.projects.length : 0;
                document.getElementById('chart-total').textContent = total;
                const scale = window.devicePixelRatio || 1;
                ctx.canvas.width = 220 * scale; ctx.canvas.height = 220 * scale;
                ctx.canvas.style.width = "220px"; ctx.canvas.style.height = "220px";
                ctx.scale(scale, scale); ctx.clearRect(0, 0, 220, 220);
                if(total === 0) {
                    ctx.beginPath(); ctx.arc(110,110, 85, 0, 2*Math.PI); ctx.strokeStyle = '#F2F2F7'; ctx.lineWidth = 25; ctx.stroke();
                } else {
                    const activeCount = this.data.projects.filter(p => p.active).length;
                    let start = -0.5 * Math.PI; 
                    const colors = { active: '#34C759', inactive: '#E5E5EA' };
                    ctx.beginPath(); ctx.arc(110,110, 85, 0, 2*Math.PI); ctx.strokeStyle = '#F2F2F7'; ctx.lineWidth = 25; ctx.stroke();
                    if(activeCount > 0) {
                        const slice = (activeCount/total) * 2 * Math.PI;
                        ctx.beginPath(); ctx.arc(110, 110, 85, start, start+slice); ctx.strokeStyle = colors.active; ctx.lineWidth = 25; ctx.lineCap = 'round'; ctx.stroke();
                    }
                }
                // Global completion
                let totalTasks = 0, doneTasks = 0;
                if(this.data.projects) this.data.projects.forEach(p => { if(p.active) { totalTasks += p.tasks.length; doneTasks += p.tasks.filter(t => t.done).length; } });
                const globalRate = totalTasks === 0 ? 0 : Math.round((doneTasks/totalTasks)*100);
                document.getElementById('global-completion-rate').textContent = `${globalRate}%`;
                document.getElementById('global-completion-bar').style.width = `${globalRate}%`;
            },
            
            // --- 4. EVENT LISTENERS ---
            setupEventListeners() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const tab = item.getAttribute('data-tab');
                        if (tab) this.navigate(tab);
                    });
                });

                const safeAdd = (id, fn) => {
                    const el = document.getElementById(id);
                    if(el) el.addEventListener('click', fn);
                };

                // Login
                safeAdd('btn-login-action', () => {
                    const input = document.getElementById('login-id-input');
                    if (input && input.value.trim() !== '') {
                        this.updateUserId(input.value.trim());
                        document.getElementById('login-overlay').style.display = 'none';
                    } else { alert("Por favor escribe un nombre."); }
                });

                safeAdd('btn-new-project', () => this.openCreateProjectModal());
                safeAdd('btn-back-projects', () => this.closeProject());
                safeAdd('btn-edit-project', () => this.openEditProjectModal());
                safeAdd('btn-save-project', (e) => this.saveProject(e));
                safeAdd('btn-cancel-project', () => this.toggleProjectModal(false));

                safeAdd('btn-new-task', () => this.openCreateTaskModal());
                safeAdd('btn-save-task', (e) => this.saveTask(e));
                safeAdd('btn-cancel-task', () => this.toggleTaskModal(false));

                safeAdd('btn-cancel-delete', () => this.toggleConfirmationModal(false));
                safeAdd('btn-confirm-delete', () => this.confirmDelete());
                safeAdd('btn-clear-data', () => this.clearData());

                safeAdd('btn-close-cal-modal', () => document.getElementById('cal-task-modal').style.display='none');
                safeAdd('btn-close-cal-modal-action', () => document.getElementById('cal-task-modal').style.display='none');
                safeAdd('btn-close-db-modal', () => document.getElementById('dashboard-detail-modal').style.display='none');

                safeAdd('btn-ai-suggest', () => this.suggestTasksWithAI());
                safeAdd('btn-ai-improve', () => this.improveTaskDescription());
                
                safeAdd('btn-change-profile-name', () => {
                   this.openProfileModal(); // NOW CALLS MODAL
                });

                // New Profile Modal Buttons
                safeAdd('btn-cancel-profile', () => this.toggleProfileModal(false));
                safeAdd('btn-save-profile', () => this.saveProfileId());

                safeAdd('btn-logout', () => { localStorage.removeItem('flujo_custom_id'); location.reload(); });

                safeAdd('card-projects', () => this.openDashboardDetail('projects'));
                safeAdd('card-today', () => this.openDashboardDetail('today'));
                safeAdd('card-completed', () => this.openDashboardDetail('completed'));

                const searchInput = document.getElementById('db-modal-search');
                if(searchInput) {
                    searchInput.addEventListener('click', () => this.toggleDropdown(true));
                    searchInput.addEventListener('keyup', () => this.filterDropdownOptions());
                }

                window.addEventListener('click', (e) => {
                    const wrapper = document.querySelector('.custom-select-wrapper');
                    if(wrapper && !wrapper.contains(e.target)) this.toggleDropdown(false);
                    if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
                });
            },

            // --- 5. HELPERS ---
            updateUserId(newId) {
                this.userId = newId;
                localStorage.setItem('flujo_custom_id', newId);
                this.renderUserId();
                this.setupFirestoreListener(); 
            },
            renderUserId() {
                const el = document.getElementById('settings-user-id');
                if(el && this.userId) el.textContent = this.userId;
            },
            setupDates() {
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                const dateDisplay = document.getElementById('date-display');
                if (dateDisplay) dateDisplay.textContent = new Date().toLocaleDateString('es-ES', options);
            },
            navigate(tabId) {
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const tabs = ['dashboard', 'proyectos', 'calendario', 'analiticas', 'configuracion'];
                const idx = tabs.indexOf(tabId);
                if(idx !== -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');
                
                // Fix View State logic
                if (tabId === 'proyectos') {
                    if (this.currentProjectId) {
                        document.getElementById('projects-view-list').style.display = 'none';
                        document.getElementById('projects-view-detail').style.display = 'block';
                    } else {
                        document.getElementById('projects-view-list').style.display = 'block';
                        document.getElementById('projects-view-detail').style.display = 'none';
                    }
                } else {
                    // Force reset project view when leaving tab
                    this.currentProjectId = null;
                    document.getElementById('projects-view-detail').style.display = 'none';
                    document.getElementById('projects-view-list').style.display = 'block';
                }

                if (tabId === 'calendario') this.renderCalendar();
                if (tabId === 'analiticas') this.renderAnalytics();
                setTimeout(() => lucide.createIcons(), 50);
            },
            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },
            toggleProjectModal(show) {
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                const modal = document.getElementById('project-modal'); modal.style.display = show ? 'flex' : 'none';
                if(!show) this.editingProjectId = null;
            },
            openCreateProjectModal() {
                this.editingProjectId = null; document.getElementById('project-modal-title').textContent = 'Nuevo Proyecto';
                const form = document.querySelector('#project-form'); if(form) form.reset();
                this.selectedColor = '#007AFF'; this.renderColorPicker(); this.toggleProjectModal(true);
            },
            openEditProjectModal() {
                if(!this.currentProjectId) return;
                const p = this.data.projects.find(proj => proj.id === this.currentProjectId); if(!p) return;
                this.editingProjectId = p.id; document.getElementById('project-modal-title').textContent = 'Editar Proyecto';
                document.getElementById('p-name').value = p.name; document.getElementById('p-contract').value = p.contractDate;
                document.getElementById('p-pubs').value = p.pubs; document.getElementById('p-active').checked = p.active;
                this.selectedColor = p.color || '#007AFF'; this.renderColorPicker(); this.toggleProjectModal(true);
            },
            saveProject(e) {
                e.preventDefault(); if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                const name = document.getElementById('p-name').value;
                const contract = document.getElementById('p-contract').value;
                const pubs = document.getElementById('p-pubs').value;
                const isActive = document.getElementById('p-active').checked;
                if(!name) { alert("Nombre requerido"); return; }
                
                let logMsg = "";
                if (this.editingProjectId) {
                    const p = this.data.projects.find(proj => proj.id === this.editingProjectId);
                    if(p) { p.name = name; p.contractDate = contract; p.pubs = pubs; p.active = isActive; p.color = this.selectedColor;
                        if(this.currentProjectId === p.id) { document.getElementById('detail-title').textContent = p.name; this.updateProjectWeeklyStats(p); }
                        logMsg = `Se ha editado el proyecto "${name}"`;
                    }
                } else {
                    this.data.projects.push({ id: Date.now(), name, date: new Date().toISOString().split('T')[0], contractDate: contract, active: isActive, pubs, color: this.selectedColor, tasks: [] });
                    this.sendNotification("Proyecto Creado", name);
                    logMsg = `Se ha creado el proyecto "${name}"`;
                }
                this.logActivity(logMsg);
                this.saveData(); this.toggleProjectModal(false); this.renderProjects();
            },
            toggleTaskModal(show) {
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                const modal = document.getElementById('task-modal');
                if(show) modal.style.display = 'flex'; else setTimeout(() => { modal.style.display = 'none'; this.editingTaskId = null; }, 10);
            },
            openCreateTaskModal() {
                this.editingTaskId = null; document.getElementById('task-modal-title').textContent = 'Nueva Tarea';
                const form = document.querySelector('#task-form'); if(form) form.reset();
                const now = new Date(); const tzOffset = now.getTimezoneOffset() * 60000;
                const nowStr = new Date(now.getTime() - tzOffset).toISOString().slice(0, 16);
                document.getElementById('t-start').value = nowStr; document.getElementById('t-end').value = nowStr;
                this.toggleTaskModal(true);
            },
            openEditTaskModal(taskId) {
                const p = this.data.projects.find(proj => proj.id === this.currentProjectId); const task = p.tasks.find(t => t.id === taskId);
                if(!task) return; this.editingTaskId = taskId;
                document.getElementById('task-modal-title').textContent = 'Editar Tarea';
                document.getElementById('t-name').value = task.text; document.getElementById('t-desc').value = task.desc;
                document.getElementById('t-start').value = task.start; document.getElementById('t-end').value = task.end;
                this.toggleTaskModal(true);
            },
            saveTask(e) {
                e.preventDefault(); if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                if (!this.currentProjectId) return;
                const name = document.getElementById('t-name').value; const desc = document.getElementById('t-desc').value;
                const start = document.getElementById('t-start').value; const end = document.getElementById('t-end').value;
                if(!name || !start || !end) { alert("Completa los campos"); return; }
                const p = this.data.projects.find(proj => proj.id === this.currentProjectId);
                let logMsg = "";
                if (this.editingTaskId) {
                    const task = p.tasks.find(t => t.id === this.editingTaskId);
                    if(task) { task.text = name; task.desc = desc; task.start = start; task.end = end; task.notifiedStart = false; task.notifiedLastDay = false; }
                    logMsg = `Se ha editado la tarea "${name}" en "${p.name}"`;
                } else {
                    p.tasks.push({ id: Date.now(), text: name, desc, start, end, done: false });
                    this.sendNotification("Nueva Tarea", name);
                    logMsg = `Se ha creado la tarea "${name}" en "${p.name}"`;
                }
                this.logActivity(logMsg);
                this.saveData(); this.toggleTaskModal(false); this.renderTasks(p);
            },
            toggleConfirmationModal(show) { const modal = document.getElementById('confirmation-modal'); modal.style.display = show ? 'flex' : 'none'; if (!show) this.pendingDelete = null; },
            deleteProject(e, id) { e.stopPropagation(); this.pendingDelete = { type: 'project', id }; document.getElementById('conf-modal-title').textContent = '¿Eliminar Proyecto?'; document.getElementById('conf-modal-msg').textContent = 'Se perderán todas las tareas.'; this.toggleConfirmationModal(true); },
            deleteTask(taskId) { this.pendingDelete = { type: 'task', id: taskId }; document.getElementById('conf-modal-title').textContent = '¿Eliminar Tarea?'; document.getElementById('conf-modal-msg').textContent = 'Se eliminará permanentemente.'; this.toggleConfirmationModal(true); },
            async confirmDelete() {
                if (!this.pendingDelete) return;
                let logMsg = "";
                if (this.pendingDelete.type === 'reset') {
                     this.data.projects = []; await this.saveData(); location.reload(); return;
                }
                if (this.pendingDelete.type === 'project') {
                    const p = this.data.projects.find(p => p.id === this.pendingDelete.id);
                    if(p) logMsg = `Se ha eliminado el proyecto "${p.name}"`;
                    this.data.projects = this.data.projects.filter(p => p.id !== this.pendingDelete.id);
                    if (this.currentProjectId === this.pendingDelete.id) this.closeProject();
                } else if (this.pendingDelete.type === 'task') {
                    const p = this.data.projects.find(proj => proj.id === this.currentProjectId);
                    if (p) { 
                        const t = p.tasks.find(tk => tk.id === this.pendingDelete.id);
                        if(t) logMsg = `Se ha eliminado la tarea "${t.text}" de "${p.name}"`;
                        p.tasks = p.tasks.filter(t => t.id !== this.pendingDelete.id); 
                        this.renderTasks(p); 
                    }
                }
                this.logActivity(logMsg);
                this.saveData(); this.renderProjects(); this.toggleConfirmationModal(false);
            },
            openProject(id) {
                this.currentProjectId = id; const p = this.data.projects.find(proj => proj.id === id);
                document.getElementById('projects-view-list').style.display = 'none'; document.getElementById('projects-view-detail').style.display = 'block';
                document.getElementById('detail-title').textContent = p.name; document.getElementById('detail-contract').textContent = p.contractDate || '-';
                document.getElementById('detail-pubs').textContent = p.pubs; document.getElementById('detail-badge').textContent = p.active ? 'Activo' : 'Inactivo';
                document.getElementById('detail-badge').className = p.active ? 'badge badge-active' : 'badge badge-inactive';
                this.renderTasks(p); lucide.createIcons();
            },
            closeProject() { this.currentProjectId = null; document.getElementById('projects-view-detail').style.display = 'none'; document.getElementById('projects-view-list').style.display = 'block'; this.renderProjects(); },
            toggleTaskDone(id) {
                const p = this.data.projects.find(proj => proj.id === this.currentProjectId);
                const t = p.tasks.find(tk => tk.id === id);
                if(t) { t.done = !t.done; this.saveData(); this.renderTasks(p); }
            },
            getTaskStatus(t) {
                if(t.done) return {label:'Finalizado', class:'ts-done'};
                const now = new Date(), start = new Date(t.start), end = new Date(t.end);
                if(isNaN(start.getTime()) || isNaN(end.getTime())) return {label:'Pendiente', class:'ts-todo'};
                if(now < start) return {label:'Pendiente', class:'ts-todo'};
                if(now > end) return {label:'Sin Publicar', class:'ts-overdue', isOverdue:true};
                return {label:'En Progreso', class:'ts-progress'};
            },
            updateProjectWeeklyStats(p) {
                const now = new Date(); const currentDay = (now.getDay() + 6) % 7; 
                const currentWeekStart = new Date(now); currentWeekStart.setDate(now.getDate() - currentDay); currentWeekStart.setHours(0,0,0,0);
                const currentWeekEnd = new Date(currentWeekStart); currentWeekEnd.setDate(currentWeekStart.getDate() + 6); currentWeekEnd.setHours(23,59,59,999);
                const prevWeekStart = new Date(currentWeekStart); prevWeekStart.setDate(currentWeekStart.getDate() - 7);
                const prevWeekEnd = new Date(currentWeekStart); prevWeekEnd.setMilliseconds(prevWeekEnd.getMilliseconds() - 1);

                let currentWeekCount = 0; let prevWeekCount = 0;
                p.tasks.forEach(t => {
                    if(t.done && t.end) { 
                        const tDate = new Date(t.end);
                        if(tDate >= currentWeekStart && tDate <= currentWeekEnd) currentWeekCount++;
                        if(tDate >= prevWeekStart && tDate <= prevWeekEnd) prevWeekCount++;
                    }
                });
                const goal = parseInt(p.pubs) || 0; let surplus = 0;
                if (goal > 0 && prevWeekCount > goal) surplus = prevWeekCount - goal;
                const totalDisplay = currentWeekCount + surplus;
                document.getElementById('weekly-count').textContent = totalDisplay;
                document.getElementById('weekly-total').textContent = `/ ${goal}`;
                const statusEl = document.getElementById('weekly-status');
                if(totalDisplay >= goal && goal > 0) { statusEl.textContent = 'Completada'; statusEl.style.color = 'var(--success)'; } 
                else { statusEl.textContent = 'Sin completar'; statusEl.style.color = 'var(--warning)'; }
            },
            openCalendarTaskInfo(pid, tid) {
                const p = this.data.projects.find(proj => proj.id === pid); const t = p.tasks.find(task => task.id === tid);
                if(p && t) {
                    document.getElementById('cal-modal-project').textContent = p.name;
                    document.getElementById('cal-modal-project').style.backgroundColor = p.color || '#007AFF';
                    document.getElementById('cal-modal-task').textContent = t.text;
                    const status = this.getTaskStatus(t);
                    document.getElementById('cal-modal-status').innerHTML = `<span class="task-status-badge ${status.class}">${status.label}</span>`;
                    const startFmt = t.start ? new Date(t.start).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : 'Sin fecha';
                    const endFmt = t.end ? new Date(t.end).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : 'Sin fecha';
                    document.getElementById('cal-modal-start').textContent = startFmt;
                    document.getElementById('cal-modal-end').textContent = endFmt;
                    document.getElementById('cal-task-modal').style.display = 'flex';
                }
            },
            clearData() { 
                this.pendingDelete = { type: 'reset' };
                document.getElementById('conf-modal-title').textContent = '¿Reiniciar Aplicación?';
                document.getElementById('conf-modal-msg').textContent = 'Se borrarán todos los proyectos y tareas. Esta acción es irreversible.';
                this.toggleConfirmationModal(true);
            },
            selectProjectFilter(id, name) {
                document.getElementById('db-modal-search').value = name; this.currentFilterValue = id;
                this.toggleDropdown(false); this.renderFilteredList();
            },
            toggleDropdown(show) {
                const list = document.getElementById('db-custom-options');
                if(show) { list.classList.add('show'); document.getElementById('db-modal-search').focus(); } else list.classList.remove('show');
            },
            filterDropdownOptions() {
                const input = document.getElementById('db-modal-search'); const filter = input.value.toLowerCase();
                const options = document.getElementsByClassName('custom-option');
                for (let i = 0; i < options.length; i++) {
                    const txtValue = options[i].textContent || options[i].innerText;
                    options[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            },
            renderFilteredList() {
                if (this.currentFilterValue === 'all') this.renderDashboardListItems(this.currentDashboardListItems);
                else {
                    const filtered = this.currentDashboardListItems.filter(item => item.project && item.project.id == this.currentFilterValue);
                    this.renderDashboardListItems(filtered);
                }
            },
            renderDashboardListItems(items) {
                const container = document.getElementById('db-modal-list'); container.innerHTML = '';
                if (items.length === 0) { container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-secondary);">No se encontraron elementos.</div>'; return; }
                items.forEach(item => {
                    const div = document.createElement('div'); div.className = 'dashboard-list-item';
                    if (item.type === 'project') {
                        const p = item.data; const pColor = p.color || '#007AFF';
                        div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><div style="width:10px; height:10px; border-radius:50%; background:${pColor};"></div><span class="dashboard-task-name">${p.name}</span></div><div style="font-size:0.8rem; color:var(--text-secondary);">${p.pubs} pubs/sem</div>`;
                    } else {
                        const t = item.data; const p = item.project; const pColor = p.color || '#007AFF';
                        div.innerHTML = `<div style="display:flex; flex-direction:column;"><span class="dashboard-task-name">${t.text}</span><span style="font-size:0.75rem; color:var(--text-secondary); margin-top:2px;">${new Date(t.end).toLocaleDateString()}</span></div><div class="dashboard-proj-tag" style="background:${pColor};">${p.name}</div>`;
                    }
                    container.appendChild(div);
                });
            },
            populateCustomOptions(set) {
                const container = document.getElementById('db-custom-options'); container.innerHTML = '';
                const allOpt = document.createElement('div'); allOpt.className = 'custom-option'; allOpt.textContent = 'Todos los proyectos';
                allOpt.onclick = () => this.selectProjectFilter('all', 'Todos los proyectos'); container.appendChild(allOpt);
                set.forEach(p => {
                    const opt = document.createElement('div'); opt.className = 'custom-option';
                    opt.innerHTML = `<div style="width:8px; height:8px; border-radius:50%; background:${p.color||'#ccc'};"></div>${p.name}`;
                    opt.onclick = () => this.selectProjectFilter(p.id, p.name); container.appendChild(opt);
                });
            },
            
            // --- 6. NEW PROFILE MODAL LOGIC ---
            toggleProfileModal(show) {
                const modal = document.getElementById('profile-modal');
                if(modal) {
                    modal.style.display = show ? 'flex' : 'none';
                    if(show) {
                        const input = document.getElementById('input-edit-profile-id');
                        if(input) {
                            input.value = this.userId;
                            input.focus();
                        }
                    }
                }
            },
            openProfileModal() {
                this.toggleProfileModal(true);
            },
            saveProfileId() {
                const input = document.getElementById('input-edit-profile-id');
                if(input && input.value.trim() !== "") {
                    this.updateUserId(input.value.trim());
                    this.toggleProfileModal(false);
                } else {
                     alert("El ID no puede estar vacío");
                }
            },
            // --- Missing function restored ---
            openDashboardDetail(type) {
                const modalList = document.getElementById('db-modal-list'); const modalTitle = document.getElementById('db-modal-title');
                const filterSection = document.getElementById('db-modal-filter-section'); const filterSelect = document.getElementById('db-modal-search');
                
                modalList.innerHTML = ''; this.currentDashboardListItems = [];
                filterSelect.value = 'Todos los proyectos'; this.currentFilterValue = 'all';

                if (type === 'projects') {
                    modalTitle.textContent = 'Proyectos Activos'; filterSection.style.display = 'none';
                    this.data.projects.filter(p => p.active).forEach(p => this.currentDashboardListItems.push({ type: 'project', data: p }));
                } else if (type === 'today') {
                    modalTitle.textContent = 'Tareas para Hoy'; filterSection.style.display = 'block';
                    const today = new Date(); today.setHours(0,0,0,0);
                    const projectsSet = new Set();
                    this.data.projects.forEach(p => {
                        if (p.active) {
                            projectsSet.add(p);
                            p.tasks.forEach(t => {
                                if (!t.done && t.start && t.end) {
                                    const start = new Date(t.start); start.setHours(0,0,0,0);
                                    const end = new Date(t.end); end.setHours(23,59,59,999);
                                    if (today >= start && today <= end) this.currentDashboardListItems.push({ type: 'task', data: t, project: p });
                                }
                            });
                        }
                    });
                    this.populateCustomOptions(projectsSet);
                } else if (type === 'completed') {
                    modalTitle.textContent = 'Tareas Finalizadas'; filterSection.style.display = 'block';
                    const projectsSet = new Set();
                    this.data.projects.forEach(p => {
                        p.tasks.forEach(t => {
                            if (t.done) { this.currentDashboardListItems.push({ type: 'task', data: t, project: p }); projectsSet.add(p); }
                        });
                    });
                    this.populateCustomOptions(projectsSet);
                }
                this.renderDashboardListItems(this.currentDashboardListItems);
                document.getElementById('dashboard-detail-modal').style.display = 'flex';
            },
            async callGeminiAPI(prompt) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) { console.error("Gemini Error:", error); return null; }
            },
            async suggestTasksWithAI() {
                const p = this.data.projects.find(proj => proj.id === this.currentProjectId); if(!p) return;
                const btn = document.querySelector('#btn-ai-suggest'); if(btn) btn.classList.add('loading');
                const prompt = `Act as a project manager. For project "${p.name}", suggest 3 concise tasks. Return ONLY valid JSON array of objects: [{"text": "Title", "desc": "Desc"}]. No markdown.`;
                const result = await this.callGeminiAPI(prompt);
                if (result) {
                    try {
                        const cleanJson = result.replace(/```json|```/g, '').trim();
                        const tasks = JSON.parse(cleanJson);
                        tasks.forEach(t => {
                            p.tasks.push({ id: Date.now() + Math.random(), text: t.text, desc: t.desc, start: new Date().toISOString().slice(0, 16), end: new Date(Date.now() + 86400000).toISOString().slice(0, 16), done: false });
                        });
                        this.saveData(); this.renderTasks(p); 
                    } catch (e) { alert("Error AI"); }
                }
                if(btn) btn.classList.remove('loading');
            },
            async improveTaskDescription() {
                const descInput = document.getElementById('t-desc'); const titleInput = document.getElementById('t-name');
                const currentDesc = descInput.value; const currentTitle = titleInput.value;
                if(!currentTitle) { alert("Escribe un nombre de tarea"); return; }
                const btn = document.querySelector('#btn-ai-improve'); if(btn) btn.classList.add('loading');
                const prompt = `Improve description for task "${currentTitle}": "${currentDesc}". Max 2 sentences, professional tone in Spanish. Return text only.`;
                const improved = await this.callGeminiAPI(prompt);
                if(improved) descInput.value = improved.trim();
                if(btn) btn.classList.remove('loading');
            }
        };

        window.app = app;
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
